# üí≥ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram Payments

–ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —á–µ—Ä–µ–∑ Telegram –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

---

## üìã –ß—Ç–æ —É–∂–µ –≥–æ—Ç–æ–≤–æ

‚úÖ **Backend —Ñ—É–Ω–∫—Ü–∏—è** –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–≤–æ–π—Å–æ–≤ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π  
‚úÖ **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π  
‚úÖ **–ê–≤—Ç–æ–∑–∞—á–∏—Å–ª–µ–Ω–∏–µ** —Å—Ä–µ–¥—Å—Ç–≤ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã  
‚úÖ **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ —Å—Ç–∞—Ç—É—Å–µ –ø–ª–∞—Ç–µ–∂–∞  
‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º –ø–æ–∫—É–ø–∫–∏ LOVE —Ç–æ–∫–µ–Ω–æ–≤  

---

## üîß –®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –ø–ª–∞—Ç—ë–∂–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

### –ß–µ—Ä–µ–∑ @BotFather:

1. –û—Ç–∫—Ä–æ–π—Ç–µ **@BotFather** –≤ Telegram
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É `/mybots`
3. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
4. –ù–∞–∂–º–∏—Ç–µ **Payments**
5. –í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞—Ç—ë–∂–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞:

   **–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (Test mode):**
   - Stripe Test Provider
   - –Ækassa Test
   
   **–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:**
   - –Ækassa (–†–æ—Å—Å–∏—è, –°–ù–ì)
   - Stripe (–º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏)
   - PayPal
   - –î—Ä—É–≥–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã

6. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (—Ñ–æ—Ä–º–∞—Ç: `1234567890:TEST:AbCdEf123456789`)
7. –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –≤ —Å–µ–∫—Ä–µ—Ç `TELEGRAM_PAYMENT_PROVIDER_TOKEN` —á–µ—Ä–µ–∑ UI –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

---

## üîê –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã

–í –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ –Ω–∞ poehali.dev —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —Å–µ–∫—Ä–µ—Ç—ã:

1. **TELEGRAM_BOT_TOKEN** - —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
2. **WEB_APP_URL** - URL –≤–∞—à–µ–≥–æ Web App
3. **TELEGRAM_PAYMENT_PROVIDER_TOKEN** ‚ö†Ô∏è **–î–û–ë–ê–í–¨–¢–ï –ï–ì–û!**

### –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ä–µ—Ç:
- –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **–°–µ–∫—Ä–µ—Ç—ã** –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞
- –ù–∞–π–¥–∏—Ç–µ `TELEGRAM_PAYMENT_PROVIDER_TOKEN`
- –í—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –∏–∑ @BotFather
- –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

---

## üß™ –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π

### –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (Stripe Test):

1. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Web App
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª –ø–æ–∫—É–ø–∫–∏ LOVE —Ç–æ–∫–µ–Ω–æ–≤
4. –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ **–ö—É–ø–∏—Ç—å**
5. Telegram –æ—Ç–ø—Ä–∞–≤–∏—Ç –≤–∞–º –∏–Ω–≤–æ–π—Å
6. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É: `4242 4242 4242 4242`
   - –õ—é–±–∞—è –¥–∞—Ç–∞ –≤ –±—É–¥—É—â–µ–º
   - –õ—é–±–æ–π CVC (–Ω–∞–ø—Ä–∏–º–µ—Ä, 123)
7. –û–ø–ª–∞—Ç–∏—Ç–µ

### –ß—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏:

‚úÖ Telegram –ø–æ–∫–∞–∂–µ—Ç "Payment successful"  
‚úÖ –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π "üöÄ –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"  
‚úÖ –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞—á–∏—Å–ª—è—Ç—Å—è LOVE —Ç–æ–∫–µ–Ω—ã  
‚úÖ –ü–æ—è–≤–∏—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "üíó LOVE —Ç–æ–∫–µ–Ω—ã –∑–∞—á–∏—Å–ª–µ–Ω—ã!"  
‚úÖ –ü–ª–∞—Ç—ë–∂ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö  

---

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `telegram_payments`:
–•—Ä–∞–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–µ–π:
- `telegram_user_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
- `telegram_payment_charge_id` - ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ Telegram
- `provider_payment_charge_id` - ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
- `amount` - —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞
- `currency` - –≤–∞–ª—é—Ç–∞ (RUB, USD –∏ —Ç.–¥.)
- `payload` - –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ (JSON)
- `status` - —Å—Ç–∞—Ç—É—Å (completed, pending, failed)
- `created_at` / `processed_at` - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏

### SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π:
```sql
SELECT * FROM telegram_payments 
ORDER BY created_at DESC 
LIMIT 10;
```

---

## üîÑ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–∑–∞—á–∏—Å–ª–µ–Ω–∏–µ

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ö—É–ø–∏—Ç—å"** ‚Üí —Å–æ–∑–¥–∞—ë—Ç—Å—è –∏–Ω–≤–æ–π—Å
2. **Telegram –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É –æ–ø–ª–∞—Ç—ã** ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
3. **Pre-checkout query** ‚Üí –±–æ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –ø—Ä–∏–Ω—è—Ç—å –ø–ª–∞—Ç—ë–∂
4. **Successful payment** ‚Üí Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–ª–∞—Ç–µ–∂–∞
5. **Backend —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î** ‚Üí –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É `telegram_payments`
6. **Backend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ** ‚Üí —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
7. **Frontend –∑–∞—á–∏—Å–ª—è–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤–∞** ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
8. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é** ‚Üí —Ç–æ—Å—Ç + —Å–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

---

## üõ†Ô∏è –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã API

### –°–æ–∑–¥–∞—Ç—å –∏–Ω–≤–æ–π—Å:
```typescript
POST https://functions.poehali.dev/05a886f0-8259-4934-933b-0f3e1e110704

Body:
{
  "action": "create_invoice",
  "chatId": 123456789,
  "amount": 1000,
  "currency": "RUB",
  "title": "–ü–æ–∫—É–ø–∫–∞ 75 LOVE —Ç–æ–∫–µ–Ω–æ–≤",
  "description": "–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞",
  "payload": {
    "type": "love_purchase",
    "rub": 1000,
    "love": 75
  }
}
```

### Webhook (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):
Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –Ω–∞ —Ç–æ—Ç –∂–µ URL –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ.

---

## üöÄ –ü—Ä–æ–¥–∞–∫—à–µ–Ω

### –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:

1. –ü–æ–ª—É—á–∏—Ç–µ **—Ä–µ–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞** (–Ω–µ Test)
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ **webhook URL** –≤ @BotFather:
   ```
   /setwebhook
   URL: https://functions.poehali.dev/05a886f0-8259-4934-933b-0f3e1e110704
   ```
3. –î–æ–±–∞–≤—å—Ç–µ **—Ä–µ–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞** –≤ —Å–µ–∫—Ä–µ—Ç—ã
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å –Ω–µ–±–æ–ª—å—à–æ–π —Å—É–º–º–æ–π
5. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ **–∫–æ–º–∏—Å—Å–∏–∏** —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (–µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ)

---

## ‚ùì –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### "Payment provider token not configured"
‚Üí –ù–µ –¥–æ–±–∞–≤–ª–µ–Ω —Å–µ–∫—Ä–µ—Ç `TELEGRAM_PAYMENT_PROVIDER_TOKEN`

### –ò–Ω–≤–æ–π—Å –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç
‚Üí –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –±–æ—Ç –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É –∏–Ω–≤–æ–π—Å–æ–≤  
‚Üí –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω –≤ @BotFather

### –°—Ä–µ–¥—Å—Ç–≤–∞ –Ω–µ –∑–∞—á–∏—Å–ª—è—é—Ç—Å—è
‚Üí –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend: `get_logs("backend/telegram-bot")`  
‚Üí –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É `telegram_payments` –≤ –ë–î

### –¢–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
‚Üí –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `4242 4242 4242 4242` —Ç–æ–ª—å–∫–æ –¥–ª—è Stripe Test  
‚Üí –î–ª—è –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ —Å–º–æ—Ç—Ä–∏—Ç–µ –∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `get_logs("backend/telegram-bot")`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î: `SELECT * FROM telegram_payments WHERE status = 'failed'`
3. –û—Ç–∫—Ä–æ–π—Ç–µ —Ç–∏–∫–µ—Ç –≤ –Ω–∞—à–µ–º —Å–æ–æ–±—â–µ—Å—Ç–≤–µ: https://t.me/+QgiLIa1gFRY4Y2Iy

---

**–ì–æ—Ç–æ–≤–æ!** –í–∞—à–∞ –ø–ª–∞—Ç—ë–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —á–µ—Ä–µ–∑ Telegram –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ! üéâ
